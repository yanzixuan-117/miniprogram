<!--pages/index/index.wxml-->
<view class="index-container">
  <!-- æœªç™»å½•çŠ¶æ€ -->
  <view class="not-login" wx:if="{{!hasLogin}}">
    <view class="welcome-banner">
      <view class="banner-bg">
        <view class="bg-circle circle-1"></view>
        <view class="bg-circle circle-2"></view>
      </view>
      <view class="banner-content">
        <text class="logo-emoji">ğŸ¾</text>
        <text class="title">æŒ¥æ‹GO</text>
        <text class="subtitle">ä¸“ä¸šçš„ç½‘çƒæ•™å­¦ç®¡ç†å¹³å°</text>
        <button class="login-btn" bindtap="goToLogin">ç«‹å³ç™»å½•</button>
      </view>
    </view>
  </view>

  <!-- å·²ç™»å½•çŠ¶æ€ -->
  <view class="logged-in" wx:if="{{hasLogin}}">
    <!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
    <view class="user-card">
      <image class="user-avatar" src="{{userInfo.avatarUrl }}" mode="aspectFill"></image>
      <view class="user-info">
        <text class="user-name">{{userInfo.nickname}}</text>
        <view class="user-role-badge {{userRole}}">
          <text class="role-emoji">{{userRole === 'guest' ? 'ğŸ‘¤' : (userRole === 'student' ? 'ğŸ¾' : (userRole === 'coach' ? 'ğŸ‘¨â€ğŸ«' : 'â­'))}}</text>
          <text class="role-text">{{userRole === 'guest' ? 'æ¸¸å®¢' : (userRole === 'student' ? 'å­¦å‘˜' : (userRole === 'coach' ? 'æ•™ç»ƒ' : 'ç®¡ç†å‘˜'))}}</text>
        </view>
      </view>
      <view class="user-action">
        <text class="action-icon">âš™ï¸</text>
      </view>
    </view>

    <!-- å­¦å‘˜è§†å›¾ï¼ˆåŒ…æ‹¬æ¸¸å®¢ï¼‰ -->
    <view class="student-view" wx:if="{{displayRole === 'student' || userRole === 'guest'}}">
      <!-- æ¸¸å®¢æç¤ºæ¨ªå¹… -->
      <view class="guest-banner" wx:if="{{userRole === 'guest'}}">
        <text class="banner-icon">ğŸ’¡</text>
        <text class="banner-text">æ‚¨å½“å‰æ˜¯æ¸¸å®¢èº«ä»½ï¼Œè¯·è”ç³»ç®¡ç†å‘˜æ·»åŠ ä¸ºå­¦å‘˜åå³å¯é¢„çº¦è¯¾ç¨‹</text>
      </view>

      <!-- ç»Ÿè®¡æ•°æ® -->
      <view class="stats-bar">
        <view class="stat-item">
          <text class="stat-number">{{studentStats.bookings || 0}}</text>
          <text class="stat-label">å·²é¢„çº¦</text>
        </view>
        <view class="stat-divider"></view>
        <view class="stat-item">
          <text class="stat-number">{{studentStats.hours || 0}}</text>
          <text class="stat-label">å­¦ä¹ æ—¶é•¿</text>
        </view>
        <view class="stat-divider"></view>
        <view class="stat-item">
          <text class="stat-number">{{studentStats.rating || 0}}</text>
          <text class="stat-label">å¹³å‡è¯„åˆ†</text>
        </view>
      </view>

      <!-- å¿«æ·æ“ä½œ -->
      <view class="quick-actions">
        <view class="action-item" bindtap="goToBooking">
          <view class="action-icon-wrapper">
            <text class="action-icon">ğŸ“…</text>
          </view>
          <text class="action-text">é¢„çº¦è¯¾ç¨‹</text>
        </view>
        <view class="action-item" bindtap="goToCoaches">
          <view class="action-icon-wrapper">
            <text class="action-icon">ğŸ‘¨â€ğŸ«</text>
          </view>
          <text class="action-text">æ‰¾æ•™ç»ƒ</text>
        </view>
        <view class="action-item" bindtap="goToMyRecords">
          <view class="action-icon-wrapper">
            <text class="action-icon">ğŸ“</text>
          </view>
          <text class="action-text">è¯¾ç¨‹è®°å½•</text>
        </view>
        <view class="action-item" bindtap="goToVideos">
          <view class="action-icon-wrapper">
            <text class="action-icon">ğŸ¬</text>
          </view>
          <text class="action-text">æ•™å­¦è§†é¢‘</text>
        </view>
      </view>

      <!-- å¾…å®¡æ ¸çš„é¢„çº¦ -->
      <view class="section" wx:if="{{pendingBookings.length > 0}}">
        <view class="section-header">
          <text class="section-title">{{displayRole === 'student' ? 'é¢„çº¦è®°å½•' : 'å¾…å®¡æ ¸é¢„çº¦'}}</text>
          <text class="section-count">{{pendingBookings.length}}</text>
        </view>
        <view class="booking-list">
          <view class="booking-item {{displayRole === 'student' ? '' : 'coach-booking'}}" wx:for="{{pendingBookings}}" wx:key="_id" bindtap="{{displayRole === 'student' ? 'viewBookingDetail' : 'handleBooking'}}" data-id="{{item._id}}">
            <view class="booking-left">
              <view class="booking-date">
                <text class="date-day">{{item.dateText.day}}</text>
                <text class="date-month">{{item.dateText.month}}æœˆ</text>
                <text class="date-weekday">å‘¨{{item.dateText.weekday}}</text>
              </view>
              <view class="booking-info">
                <text class="{{displayRole === 'student' ? 'coach-name' : 'student-name'}}">{{displayRole === 'student' ? (item.coachName || 'æ•™ç»ƒ') : item.studentName}}</text>
                <text class="booking-time">{{item.startTime}}-{{item.endTime}}</text>
                <text class="booking-date-text" wx:if="{{item.venue}}">ğŸ“ {{item.venue}}</text>
                <text class="fixed-badge" wx:if="{{item.isFixed}}">ğŸ”„ å›ºå®š</text>
                <!-- ä¸Šè¯¾äººåˆ—è¡¨ -->
                <view class="students-info" wx:if="{{displayRole === 'coach' && item.students && item.students.length > 0}}">
                  <text class="students-label">ä¸Šè¯¾äººï¼š</text>
                  <text class="students-names">
                    <text>{{item.studentName}}</text>
                    <text>ã€</text>
                    <block wx:for="{{item.students}}" wx:key="name" wx:for-index="sIdx" wx:for-item="student">
                      <text>{{student.name}}</text>
                      <text wx:if="{{sIdx < item.students.length - 1}}">ã€</text>
                    </block>
                  </text>
                </view>
              </view>
            </view>
            <view class="booking-status status-{{item.status}}">{{item.statusText}}</view>
          </view>
        </view>
      </view>

      <!-- å¾…ä¸Šè¯¾çš„è¯¾ç¨‹ -->
      <view class="section" wx:if="{{confirmedBookings.length > 0}}">
        <view class="section-header">
          <text class="section-title">{{displayRole === 'student' ? 'å¾…ä¸Šè¯¾' : 'è¯¾ç¨‹å®‰æ’'}}</text>
        </view>
        <view class="booking-list">
          <view class="booking-item {{displayRole === 'student' ? '' : 'coach-booking'}}" wx:for="{{confirmedBookings}}" wx:key="_id" bindtap="{{displayRole === 'student' ? 'viewBookingDetail' : 'handleBooking'}}" data-id="{{item._id}}">
            <view class="booking-left">
              <view class="booking-date">
                <text class="date-day">{{item.dateText.day}}</text>
                <text class="date-month">{{item.dateText.month}}æœˆ</text>
                <text class="date-weekday">å‘¨{{item.dateText.weekday}}</text>
              </view>
              <view class="booking-info">
                <text class="{{displayRole === 'student' ? 'coach-name' : 'student-name'}}">{{displayRole === 'student' ? (item.coachName || 'æ•™ç»ƒ') : item.studentName}}</text>
                <text class="booking-time">{{item.startTime}}-{{item.endTime}}</text>
                <text class="booking-date-text" wx:if="{{item.venue}}">ğŸ“ {{item.venue}}</text>
                <text class="fixed-badge" wx:if="{{item.isFixed}}">ğŸ”„ å›ºå®š</text>
                <!-- ä¸Šè¯¾äººåˆ—è¡¨ -->
                <view class="students-info" wx:if="{{displayRole === 'coach' && item.students && item.students.length > 0}}">
                  <text class="students-label">ä¸Šè¯¾äººï¼š</text>
                  <text class="students-names">
                    <text>{{item.studentName}}</text>
                    <text>ã€</text>
                    <block wx:for="{{item.students}}" wx:key="name" wx:for-index="sIdx" wx:for-item="student">
                      <text>{{student.name}}</text>
                      <text wx:if="{{sIdx < item.students.length - 1}}">ã€</text>
                    </block>
                  </text>
                </view>
              </view>
            </view>
            <view class="booking-status status-{{item.status}}">{{item.statusText}}</view>
          </view>
        </view>
      </view>

      <!-- ç©ºçŠ¶æ€ -->
      <view class="empty-state" wx:if="{{pendingBookings.length === 0 && confirmedBookings.length === 0}}">
        <text class="empty-icon">ğŸ“…</text>
        <text class="empty-text">{{displayRole === 'student' ? 'ä»Šå¤©æš‚æ— è¯¾ç¨‹' : 'ä»Šå¤©æš‚æ— è¯¾ç¨‹å®‰æ’'}}</text>
        <text class="empty-hint">{{displayRole === 'student' ? 'å¿«å»é¢„çº¦ä¸€èŠ‚ç½‘çƒè¯¾ç¨‹å§' : ''}}</text>
      </view>

      <!-- æ¨èæ•™ç»ƒ -->
      <view class="section" wx:if="{{recommendedCoaches.length > 0}}">
        <view class="section-header">
          <text class="section-title">æ¨èæ•™ç»ƒ</text>
          <text class="more" bindtap="goToCoaches">æŸ¥çœ‹å…¨éƒ¨ ></text>
        </view>
        <scroll-view class="coach-scroll" scroll-x enhanced show-scrollbar="{{false}}">
          <view class="coach-list">
            <view class="coach-card" wx:for="{{recommendedCoaches}}" wx:key="_id" bindtap="viewCoachDetail" data-id="{{item._id}}">
              <image class="coach-avatar"
                     src="{{item.avatarUrl || item.cloudAvatarUrl }}"
                     mode="aspectFill"
                     binderror="onImageError"
                     data-index="{{index}}"
                     data-cloudurl="{{item.cloudAvatarUrl}}">
              </image>
              <text class="coach-name">{{item.name || 'æ•™ç»ƒ'}}</text>
              <view class="coach-rating">
                <text class="star">â­</text>
                <text class="rating">{{item.rating || '5.0'}}</text>
                <text class="count">({{item.reviewCount || 0}})</text>
              </view>
            </view>
          </view>
        </scroll-view>
      </view>

      <!-- çƒ­é—¨æ•™ç¨‹ -->
      <view class="section" wx:if="{{hotVideos.length > 0}}">
        <view class="section-header">
          <text class="section-title">çƒ­é—¨æ•™ç¨‹</text>
          <text class="more" bindtap="goToVideos">æŸ¥çœ‹å…¨éƒ¨ ></text>
        </view>
        <view class="video-grid">
          <view class="video-item" wx:for="{{hotVideos}}" wx:key="_id" bindtap="watchVideo" data-id="{{item._id}}">
            <image class="video-thumb" src="{{item.thumbnail || '/images/default-video.png'}}" mode="aspectFill"></image>
            <view class="video-play">
              <text class="play-icon">â–¶</text>
            </view>
            <text class="video-title">{{item.title}}</text>
            <view class="video-info">
              <text class="view-count">ğŸ‘ {{item.viewCount || 0}}</text>
              <text class="duration">â± {{item.durationText || '00:00'}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- æ•™ç»ƒè§†å›¾ -->
    <view class="coach-view" wx:if="{{displayRole === 'coach' || displayRole === 'admin'}}">
      <!-- ç»Ÿè®¡æ•°æ® -->
      <view class="stats-bar">
        <view class="stat-item">
          <text class="stat-number">{{coachStats.pendingCount || 0}}</text>
          <text class="stat-label">å¾…å®¡æ ¸</text>
        </view>
        <view class="stat-divider"></view>
        <view class="stat-item">
          <text class="stat-number">{{coachStats.todayCount || 0}}</text>
          <text class="stat-label">ä»Šæ—¥è¯¾ç¨‹</text>
        </view>
        <view class="stat-divider"></view>
        <view class="stat-item">
          <text class="stat-number">{{coachStats.totalStudents || 0}}</text>
          <text class="stat-label">å­¦å‘˜æ€»æ•°</text>
        </view>
      </view>

      <!-- å¿«æ·æ“ä½œ -->
      <view class="quick-actions">
        <view class="action-item" bindtap="goToBookingManage">
          <view class="action-icon-wrapper">
            <text class="action-icon">ğŸ“‹</text>
          </view>
          <text class="action-text">é¢„çº¦ç®¡ç†</text>
        </view>
        <view class="action-item" bindtap="goToSessionHistory">
          <view class="action-icon-wrapper">
            <text class="action-icon">ğŸ“</text>
          </view>
          <text class="action-text">è¯¾ç¨‹è®°å½•</text>
        </view>
        <view class="action-item" bindtap="goToVideoUpload">
          <view class="action-icon-wrapper">
            <text class="action-icon">ğŸ¬</text>
          </view>
          <text class="action-text">ä¸Šä¼ è§†é¢‘</text>
        </view>
        <view class="action-item" bindtap="goToSchedule">
          <view class="action-icon-wrapper">
            <text class="action-icon">â°</text>
          </view>
          <text class="action-text">æ—¶é—´è®¾ç½®</text>
        </view>
      </view>

      <!-- ç®¡ç†å‘˜ä¸“å±åŠŸèƒ½ -->
      <view class="admin-section" wx:if="{{userRole === 'admin'}}">
        <view class="section-header">
          <text class="section-title">ğŸ›¡ï¸ ç®¡ç†å‘˜åŠŸèƒ½</text>
        </view>
        <view class="quick-actions">
          <view class="action-item" bindtap="goToCoachManage">
            <view class="action-icon-wrapper admin">
              <text class="action-icon">ğŸ‘¨â€ğŸ«</text>
            </view>
            <text class="action-text">æ•™ç»ƒç®¡ç†</text>
          </view>
          <view class="action-item" bindtap="goToVenueManage">
            <view class="action-icon-wrapper admin">
              <text class="action-icon">ğŸŸï¸</text>
            </view>
            <text class="action-text">çƒé¦†ç®¡ç†</text>
          </view>
          <view class="action-item" bindtap="goToStudentManage">
            <view class="action-icon-wrapper admin">
              <text class="action-icon">ğŸ“</text>
            </view>
            <text class="action-text">å­¦å‘˜ç®¡ç†</text>
          </view>
          <view class="action-item" bindtap="goToRoleSwitch">
            <view class="action-icon-wrapper admin">
              <text class="action-icon">ğŸ”„</text>
            </view>
            <text class="action-text">è§’è‰²åˆ‡æ¢</text>
          </view>
        </view>
      </view>

      <!-- å¾…å®¡æ ¸çš„é¢„çº¦ -->
      <view class="section" wx:if="{{pendingBookings.length > 0}}">
        <view class="section-header">
          <text class="section-title">å¾…å®¡æ ¸é¢„çº¦</text>
          <text class="section-count">{{pendingBookings.length}}</text>
        </view>
        <view class="booking-list">
          <view class="booking-item coach-booking" wx:for="{{pendingBookings}}" wx:key="_id" bindtap="handleBooking" data-id="{{item._id}}">
            <view class="booking-left">
              <view class="booking-date">
                <text class="date-day">{{item.dateText.day}}</text>
                <text class="date-month">{{item.dateText.month}}æœˆ</text>
                <text class="date-weekday">å‘¨{{item.dateText.weekday}}</text>
              </view>
              <view class="booking-info">
                <text class="student-name">{{item.studentName}}</text>
                <text class="booking-time">{{item.startTime}}-{{item.endTime}}</text>
                <text class="booking-date-text" wx:if="{{item.venue}}">ğŸ“ {{item.venue}}</text>
                <text class="fixed-badge" wx:if="{{item.isFixed}}">ğŸ”„ å›ºå®š</text>
                <!-- ä¸Šè¯¾äººåˆ—è¡¨ -->
                <view class="students-info" wx:if="{{item.students && item.students.length > 0}}">
                  <text class="students-label">ä¸Šè¯¾äººï¼š</text>
                  <text class="students-names">
                    <text>{{item.studentName}}</text>
                    <text>ã€</text>
                    <block wx:for="{{item.students}}" wx:key="name" wx:for-index="sIdx" wx:for-item="student">
                      <text>{{student.name}}</text>
                      <text wx:if="{{sIdx < item.students.length - 1}}">ã€</text>
                    </block>
                  </text>
                </view>
              </view>
            </view>
            <view class="booking-status status-{{item.status}}">{{item.statusText}}</view>
          </view>
        </view>
      </view>

      <!-- å¾…ä¸Šè¯¾çš„è¯¾ç¨‹ -->
      <view class="section" wx:if="{{confirmedBookings.length > 0}}">
        <view class="section-header">
          <text class="section-title">è¯¾ç¨‹å®‰æ’</text>
        </view>
        <view class="booking-list">
          <view class="booking-item coach-booking" wx:for="{{confirmedBookings}}" wx:key="_id" bindtap="handleBooking" data-id="{{item._id}}">
            <view class="booking-left">
              <view class="booking-date">
                <text class="date-day">{{item.dateText.day}}</text>
                <text class="date-month">{{item.dateText.month}}æœˆ</text>
                <text class="date-weekday">å‘¨{{item.dateText.weekday}}</text>
              </view>
              <view class="booking-info">
                <text class="student-name">{{item.studentName}}</text>
                <text class="booking-time">{{item.startTime}}-{{item.endTime}}</text>
                <text class="booking-date-text" wx:if="{{item.venue}}">ğŸ“ {{item.venue}}</text>
                <text class="fixed-badge" wx:if="{{item.isFixed}}">ğŸ”„ å›ºå®š</text>
                <!-- ä¸Šè¯¾äººåˆ—è¡¨ -->
                <view class="students-info" wx:if="{{item.students && item.students.length > 0}}">
                  <text class="students-label">ä¸Šè¯¾äººï¼š</text>
                  <text class="students-names">
                    <text>{{item.studentName}}</text>
                    <text>ã€</text>
                    <block wx:for="{{item.students}}" wx:key="name" wx:for-index="sIdx" wx:for-item="student">
                      <text>{{student.name}}</text>
                      <text wx:if="{{sIdx < item.students.length - 1}}">ã€</text>
                    </block>
                  </text>
                </view>
              </view>
            </view>
            <view class="booking-status status-{{item.status}}">{{item.statusText}}</view>
          </view>
        </view>
      </view>

      <!-- ç©ºçŠ¶æ€ -->
      <view class="empty-state" wx:if="{{pendingBookings.length === 0 && confirmedBookings.length === 0}}">
        <text class="empty-icon">ğŸ“…</text>
        <text class="empty-text">ä»Šå¤©æš‚æ— è¯¾ç¨‹å®‰æ’</text>
      </view>
    </view>
  </view>
</view>

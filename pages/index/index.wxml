<!--pages/index/index.wxml-->
<view class="index-container">
  <!-- æœªç™»å½•çŠ¶æ€ -->
  <view class="not-login" wx:if="{{!hasLogin}}">
    <view class="welcome-banner">
      <view class="banner-bg">
        <view class="bg-circle circle-1"></view>
        <view class="bg-circle circle-2"></view>
      </view>
      <view class="banner-content">
        <text class="logo-emoji">ğŸ¾</text>
        <text class="title">æŒ¥æ‹GO</text>
        <text class="subtitle">ä¸“ä¸šçš„ç½‘çƒæ•™å­¦ç®¡ç†å¹³å°</text>
        <button class="login-btn" bindtap="goToLogin">ç«‹å³ç™»å½•</button>
      </view>
    </view>
  </view>

  <!-- å·²ç™»å½•çŠ¶æ€ -->
  <view class="logged-in" wx:if="{{hasLogin}}">
    <!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ -->
    <view class="user-card">
      <image class="user-avatar" src="{{userInfo.avatarUrl || '/images/avatar.png'}}" mode="aspectFill"></image>
      <view class="user-info">
        <text class="user-name">{{userInfo.nickname}}</text>
        <view class="user-role-badge {{displayRole}}">
          <text class="role-emoji">{{displayRole === 'student' ? 'ğŸ¾' : (displayRole === 'coach' ? 'ğŸ‘¨â€ğŸ«' : 'â­')}}</text>
          <text class="role-text">{{displayRole === 'student' ? 'å­¦å‘˜' : (displayRole === 'coach' ? 'æ•™ç»ƒ' : 'ç®¡ç†å‘˜')}}</text>
        </view>
      </view>
      <view class="user-action">
        <text class="action-icon">âš™ï¸</text>
      </view>
    </view>

    <!-- å­¦å‘˜è§†å›¾ -->
    <view class="student-view" wx:if="{{displayRole === 'student'}}">
      <!-- ç»Ÿè®¡æ•°æ® -->
      <view class="stats-bar">
        <view class="stat-item">
          <text class="stat-number">{{studentStats.bookings || 0}}</text>
          <text class="stat-label">å·²é¢„çº¦</text>
        </view>
        <view class="stat-divider"></view>
        <view class="stat-item">
          <text class="stat-number">{{studentStats.hours || 0}}</text>
          <text class="stat-label">å­¦ä¹ æ—¶é•¿</text>
        </view>
        <view class="stat-divider"></view>
        <view class="stat-item">
          <text class="stat-number">{{studentStats.rating || 0}}</text>
          <text class="stat-label">å¹³å‡è¯„åˆ†</text>
        </view>
      </view>

      <!-- å¿«æ·æ“ä½œ -->
      <view class="quick-actions">
        <view class="action-item" bindtap="goToBooking">
          <view class="action-icon-wrapper">
            <text class="action-icon">ğŸ“…</text>
          </view>
          <text class="action-text">é¢„çº¦è¯¾ç¨‹</text>
        </view>
        <view class="action-item" bindtap="goToCoaches">
          <view class="action-icon-wrapper">
            <text class="action-icon">ğŸ‘¨â€ğŸ«</text>
          </view>
          <text class="action-text">æ‰¾æ•™ç»ƒ</text>
        </view>
        <view class="action-item" bindtap="goToMyRecords">
          <view class="action-icon-wrapper">
            <text class="action-icon">ğŸ“</text>
          </view>
          <text class="action-text">è¯¾ç¨‹è®°å½•</text>
        </view>
        <view class="action-item" bindtap="goToVideos">
          <view class="action-icon-wrapper">
            <text class="action-icon">ğŸ¬</text>
          </view>
          <text class="action-text">æ•™å­¦è§†é¢‘</text>
        </view>
      </view>

      <!-- å¾…å¤„ç†é¢„çº¦ -->
      <view class="section" wx:if="{{pendingBookings.length > 0}}">
        <view class="section-header">
          <text class="section-title">å¾…å¤„ç†é¢„çº¦</text>
          <text class="more" bindtap="goToMyBookings">æŸ¥çœ‹å…¨éƒ¨ ></text>
        </view>
        <view class="booking-list">
          <view class="booking-item" wx:for="{{pendingBookings}}" wx:key="_id" bindtap="viewBookingDetail" data-id="{{item._id}}">
            <view class="booking-left">
              <view class="booking-date">
                <text class="date-day">{{item.dateText.day}}</text>
                <text class="date-month">{{item.dateText.month}}</text>
              </view>
              <view class="booking-info">
                <text class="coach-name">{{item.coachName || 'æ•™ç»ƒ'}}</text>
                <text class="booking-time">{{item.startTime}}-{{item.endTime}}</text>
              </view>
            </view>
            <view class="booking-status status-{{item.status}}">{{item.statusText}}</view>
          </view>
        </view>
      </view>

      <!-- æ¨èæ•™ç»ƒ -->
      <view class="section" wx:if="{{recommendedCoaches.length > 0}}">
        <view class="section-header">
          <text class="section-title">æ¨èæ•™ç»ƒ</text>
          <text class="more" bindtap="goToCoaches">æŸ¥çœ‹å…¨éƒ¨ ></text>
        </view>
        <scroll-view class="coach-scroll" scroll-x enhanced show-scrollbar="{{false}}">
          <view class="coach-list">
            <view class="coach-card" wx:for="{{recommendedCoaches}}" wx:key="_id" bindtap="viewCoachDetail" data-id="{{item._id}}">
              <image class="coach-avatar" src="{{item.avatarUrl || '/images/avatar.png'}}" mode="aspectFill"></image>
              <text class="coach-name">{{item.name || 'æ•™ç»ƒ'}}</text>
              <view class="coach-tags">
                <text class="tag">{{item.specialty && item.specialty[0] ? item.specialty[0] : 'ç½‘çƒæ•™å­¦'}}</text>
              </view>
              <view class="coach-rating">
                <text class="star">â­</text>
                <text class="rating">{{item.rating || '5.0'}}</text>
                <text class="count">({{item.reviewCount || 0}})</text>
              </view>
            </view>
          </view>
        </scroll-view>
      </view>

      <!-- çƒ­é—¨æ•™ç¨‹ -->
      <view class="section" wx:if="{{hotVideos.length > 0}}">
        <view class="section-header">
          <text class="section-title">çƒ­é—¨æ•™ç¨‹</text>
          <text class="more" bindtap="goToVideos">æŸ¥çœ‹å…¨éƒ¨ ></text>
        </view>
        <view class="video-grid">
          <view class="video-item" wx:for="{{hotVideos}}" wx:key="_id" bindtap="watchVideo" data-id="{{item._id}}">
            <image class="video-thumb" src="{{item.thumbnail || '/images/default-video.png'}}" mode="aspectFill"></image>
            <view class="video-play">
              <text class="play-icon">â–¶</text>
            </view>
            <text class="video-title">{{item.title}}</text>
            <view class="video-info">
              <text class="view-count">ğŸ‘ {{item.viewCount || 0}}</text>
              <text class="duration">â± {{item.durationText || '00:00'}}</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- æ•™ç»ƒè§†å›¾ -->
    <view class="coach-view" wx:if="{{displayRole === 'coach' || displayRole === 'admin'}}">
      <!-- ç»Ÿè®¡æ•°æ® -->
      <view class="stats-bar">
        <view class="stat-item">
          <text class="stat-number">{{coachStats.pendingCount || 0}}</text>
          <text class="stat-label">å¾…å®¡æ ¸</text>
        </view>
        <view class="stat-divider"></view>
        <view class="stat-item">
          <text class="stat-number">{{coachStats.todayCount || 0}}</text>
          <text class="stat-label">ä»Šæ—¥è¯¾ç¨‹</text>
        </view>
        <view class="stat-divider"></view>
        <view class="stat-item">
          <text class="stat-number">{{coachStats.totalStudents || 0}}</text>
          <text class="stat-label">å­¦å‘˜æ€»æ•°</text>
        </view>
      </view>

      <!-- å¿«æ·æ“ä½œ -->
      <view class="quick-actions">
        <view class="action-item" bindtap="goToBookingManage">
          <view class="action-icon-wrapper">
            <text class="action-icon">ğŸ“‹</text>
          </view>
          <text class="action-text">é¢„çº¦ç®¡ç†</text>
        </view>
        <view class="action-item" bindtap="goToSessionHistory">
          <view class="action-icon-wrapper">
            <text class="action-icon">ğŸ“</text>
          </view>
          <text class="action-text">è¯¾ç¨‹è®°å½•</text>
        </view>
        <view class="action-item" bindtap="goToVideoUpload">
          <view class="action-icon-wrapper">
            <text class="action-icon">ğŸ¬</text>
          </view>
          <text class="action-text">ä¸Šä¼ è§†é¢‘</text>
        </view>
        <view class="action-item" bindtap="goToSchedule">
          <view class="action-icon-wrapper">
            <text class="action-icon">â°</text>
          </view>
          <text class="action-text">æ—¶é—´è®¾ç½®</text>
        </view>
      </view>

      <!-- ç®¡ç†å‘˜ä¸“å±åŠŸèƒ½ -->
      <view class="admin-section" wx:if="{{displayRole === 'admin'}}">
        <view class="section-header">
          <text class="section-title">ğŸ›¡ï¸ ç®¡ç†å‘˜åŠŸèƒ½</text>
        </view>
        <view class="quick-actions">
          <view class="action-item" bindtap="goToCoachManage">
            <view class="action-icon-wrapper admin">
              <text class="action-icon">ğŸ‘¨â€ğŸ«</text>
            </view>
            <text class="action-text">æ•™ç»ƒç®¡ç†</text>
          </view>
          <view class="action-item" bindtap="goToVenueManage">
            <view class="action-icon-wrapper admin">
              <text class="action-icon">ğŸŸï¸</text>
            </view>
            <text class="action-text">çƒé¦†ç®¡ç†</text>
          </view>
          <view class="action-item" bindtap="goToRoleSwitch">
            <view class="action-icon-wrapper admin">
              <text class="action-icon">ğŸ”„</text>
            </view>
            <text class="action-text">è§’è‰²åˆ‡æ¢</text>
          </view>
        </view>
      </view>

      <!-- å¾…å®¡æ ¸é¢„çº¦ -->
      <view class="section" wx:if="{{pendingBookings.length > 0}}">
        <view class="section-header">
          <text class="section-title">å¾…å®¡æ ¸é¢„çº¦</text>
          <view class="badge">{{pendingBookings.length}}</view>
        </view>
        <view class="booking-list">
          <view class="booking-item coach-booking" wx:for="{{pendingBookings}}" wx:key="_id">
            <view class="booking-header" bindtap="handleBooking" data-id="{{item._id}}">
              <view class="booking-date">
                <text class="date-day">{{item.dateText.day}}</text>
                <text class="date-month">{{item.dateText.month}}</text>
              </view>
              <view class="booking-info">
                <text class="student-name">{{item.studentName}}</text>
                <text class="booking-time">{{item.startTime}}-{{item.endTime}}</text>
                <!-- ä¸Šè¯¾äººåˆ—è¡¨ -->
                <view class="students-info" wx:if="{{item.students && item.students.length > 0}}">
                  <text class="students-label">ä¸Šè¯¾äººï¼š</text>
                  <text class="students-names">
                    <text>{{item.studentName}}</text>
                    <text>ã€</text>
                    <block wx:for="{{item.students}}" wx:key="name" wx:for-index="sIdx" wx:for-item="student">
                      <text>{{student.name}}</text>
                      <text wx:if="{{sIdx < item.students.length - 1}}">ã€</text>
                    </block>
                  </text>
                </view>
                <text class="booking-note" wx:if="{{item.studentNote}}">å¤‡æ³¨ï¼š{{item.studentNote}}</text>
              </view>
            </view>
            <view class="booking-actions">
              <button class="action-btn approve" catchtap="approveBooking" data-id="{{item._id}}">åŒæ„</button>
              <button class="action-btn reject" catchtap="rejectBooking" data-id="{{item._id}}">æ‹’ç»</button>
            </view>
          </view>
        </view>
      </view>

      <!-- ä»Šæ—¥è¯¾ç¨‹ -->
      <view class="section" wx:if="{{todayBookings.length > 0}}">
        <view class="section-header">
          <text class="section-title">ä»Šæ—¥è¯¾ç¨‹</text>
        </view>
        <view class="booking-list">
          <view class="booking-item" wx:for="{{todayBookings}}" wx:key="_id" bindtap="createSessionRecord" data-id="{{item._id}}">
            <view class="booking-left">
              <view class="booking-date">
                <text class="time-slot">{{item.startTime}}</text>
                <text class="time-divider">-</text>
                <text class="time-slot">{{item.endTime}}</text>
              </view>
              <view class="booking-info">
                <text class="student-name">{{item.studentName}}</text>
                <!-- ä¸Šè¯¾äººåˆ—è¡¨ -->
                <view class="students-info" wx:if="{{item.students && item.students.length > 0}}">
                  <text class="students-label">ä¸Šè¯¾äººï¼š</text>
                  <text class="students-names">
                    <text>{{item.studentName}}</text>
                    <text>ã€</text>
                    <block wx:for="{{item.students}}" wx:key="name" wx:for-index="sIdx" wx:for-item="student">
                      <text>{{student.name}}</text>
                      <text wx:if="{{sIdx < item.students.length - 1}}">ã€</text>
                    </block>
                  </text>
                </view>
                <text class="booking-note" wx:if="{{item.studentNote}}">å¤‡æ³¨ï¼š{{item.studentNote}}</text>
              </view>
            </view>
            <view class="booking-status status-confirmed">å·²ç¡®è®¤</view>
          </view>
        </view>
      </view>

      <!-- ç©ºçŠ¶æ€ -->
      <view class="empty-state" wx:if="{{pendingBookings.length === 0 && todayBookings.length === 0}}">
        <text class="empty-icon">ğŸ“…</text>
        <text class="empty-text">æš‚æ— è¯¾ç¨‹å®‰æ’</text>
        <text class="empty-hint">å¼€å§‹æ·»åŠ æ‚¨çš„è¯¾ç¨‹å®‰æ’å§</text>
      </view>
    </view>
  </view>
</view>
